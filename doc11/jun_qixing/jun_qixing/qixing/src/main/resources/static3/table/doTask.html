<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>layui</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="stylesheet" href="/lib/layui-v2.5.5/css/layui.css" media="all">
    <link rel="stylesheet" href="/css/public.css" media="all">
    <style>
        body {
            background-color: #ffffff;
        }
    </style>
</head>
<body>

<div class="layui-form layuimini-form">
    <div class="layui-form-item">
        <label class="layui-form-label ">审批人</label>
        <div class="layui-input-block">
            <input name="operatorNextid" id="operatorNextid" hidden/>
			<input type="text" name="operatorNext"  id="operatorNext"  lay-max="256" readonly="readonly"   
				  placeholder="请选择下一环节审批人(驳回及最终环节无需填写)"   autocomplete="off" class="layui-input">
				  <!-- lay-verify="required|operatorNext" -->
        </div>
    </div>
    
    <div class="layui-form-item layui-form-text">
        <label class="layui-form-label  required">处理意见</label>
        <div class="layui-input-block">
            <textarea  name="taskOperatorMsg"  id="taskOperatorMsg"  lay-max="256" 
					   	placeholder="请输入处理意见"  lay-verify="required|taskOperatorMsg"   autocomplete="off"   class="layui-textarea"></textarea>
        </div>
    </div>
    
    <div class="layui-form-item" id="nextAprove" ></div>

    <div class="layui-form-item">
        <div class="layui-input-block">
            <button class="layui-btn layui-btn-normal" lay-submit lay-filter="saveBtn">确认提交</button>
            <button class="layui-btn layui-btn-warming" lay-submit lay-filter="withRefuse">驳回到发起人</button>
<!--                     <button class="pear-btn layui-btn-normal  pear-btn-success" id="withAgree" lay-event="agree">同意</button> -->
<!--     				<button class="pear-btn layui-btn-normal pear-btn-warming" id="withRefuse" lay-event="refuse">驳回到发起人</button>  -->
        </div>
    </div>
</div>
<script src="/layui/layui.all.js"></script>
<script src="/layui-ext/tableSelect.js"></script>
<script src="/lib/lay-module/xmSelect/xm-select.js"></script>
<script src="/js/core.util.js"></script>
<script src="/js/jquery.js"></script>

<link rel="stylesheet" href="/assets/module/admin.css"/>
<script src="/assets/module/admin.js"></script>

<script id="demo" type="text/html">
  {{#  if(d.isNextAprove == 0){ }}
        <label class="layui-form-label">下一流程节点</label>
        <div class="layui-input-block">
            <input type="radio" name="flag" value="0" title="{{ d.text1 }}" checked="checked">
            <input type="radio" name="flag" value="2" title="{{ d.text2 }}">
        </div>
  {{#  } }}
</script>
<script>
	//获取token
	var token = CoreUtil.getData("access_token");
	var data_doTask = CoreUtil.getData("data_doTask");
	//地址栏转义token中的#号
	var tokenQuery = token==null?"":token.replace("#", "%23");
	var $ = jQuery = layui.jquery;
	var tplData = { isNextAprove:1, text1:"结束流程", text2:"董事长审批"  };
	$(function () {
		var obj = data_doTask;
    	var taskid = obj.data['id'];
    	var processName = obj.data['processName'];
    	var taskName = obj.data['taskName'];
    	console.log(processName);
    	console.log(taskName);
    	if("项目立项流程"==processName){
	    	if("部门经理审批"==taskName){
	    		// tplData = { isNextAprove:0, text1:"结束流程", text2:"董事长审批"  };
	    	}
    	}
    	if("业务约定书流程"==processName){
	    	if("部门经理审批"==taskName){
	    		tplData = { isNextAprove:0, text1:"结束流程", text2:"董事长审批"  };
	    	}
    	}
    	if("项目计划流程"==processName){
	    	if("部门经理审批"==taskName){
	    		tplData = { isNextAprove:0, text1:"结束流程", text2:"董事长审批"  };
	    	}
    	}
    	if("项目发票及收款流程"==processName){
	    	if("部门经理审批"==taskName){
	    		tplData = { isNextAprove:0, text1:"财务人员审批", text2:"董事长审批"  };
	    	}
    	}
    	if("报销电子流"==processName){
	    	if("部门经理审批"==taskName){
	    		tplData = { isNextAprove:0, text1:"结束流程", text2:"董事长审批"  };
	    	}
    	}
    	if("请假流程测试"==processName){
	    	if("部门经理审批"==taskName){
	    		tplData = { isNextAprove:0, text1:"结束流程", text2:"总经理审批"  };
	    	}
    	}
    	if("招聘录用电子流"==processName){
	    	if("部门经理审批"==taskName){
	    		tplData = { isNextAprove:0, text1:"结束流程", text2:"董事长审批"  };
	    	}
    	}
    	if("客户审批"==processName){
	    	if("董事长审批"==taskName){
	    		tplData = { isNextAprove:0, text1:"结束流程", text2:"董事长审批"  };
	    	}
    	}
    	console.log("tplData="+tplData);
    	
    });
	layui.use(['laytpl','table', 'form', 'jquery', 'element'], function () {			
        var form = layui.form,
        layer = layui.layer,
        $ = layui.$;
		var tableSelect = layui.tableSelect;
		var laytpl = layui.laytpl;
        var rowData;
        
        var getTpl = demo.innerHTML;
		var nextAprove = document.getElementById('nextAprove');
		laytpl(getTpl).render(tplData, function(html){
			nextAprove.innerHTML = html;
			form.render();
		});
		
		var obj = data_doTask;
    	var taskid = obj.data['id'];
    	var processName = obj.data['processName'];
    	var processId = obj.data['processId'];
    	var taskName = obj.data['taskName'];
		
        //监听提交
         form.on('submit(saveBtn)', function (data) {
        	 window.agree();
            return false;
        }); 
          
         form.on('submit(withRefuse)', function (data) {
        	 $("#taskOperatorFlag").val("");
        	 window.refuse();
            return false;
        }); 
        
        window.agree = function (status) {
        	var obj = data_doTask;
        	var taskid = obj.data['id'];
        	var processName = obj.data['processName'];
        	var processId = obj.data['processId'];
        	var taskName = obj.data['taskName'];
        	var operatorNext = $("#operatorNext").val();
        	var operatorNextid = $("#operatorNextid").val();
        	var taskOperatorMsg = $("#taskOperatorMsg").val();
        	var taskOperatorFlag = "同意";
        	var flag = $("input:radio[name='flag']:checked").val();
        	flag = flag==undefined?0:flag;
        	console.log("flag="+flag);
        	console.log(flag!='0');
//         	if(flag!='0' && operatorNext.length == 0 ){
// 				 layer.alert('流程下一环节审批人不能为空，请选择下一步审批人员！', {icon: 9});
// 				 return false;
//         	}
        	if(taskOperatorMsg.length == 0){
				 layer.alert('下一环节审批意见不能为空，请维护审批意见！', {icon: 3});
				 return false;
        	}
//         	return false;
        	var url = "/flow/task/approval?taskId=" +taskid+"&operatorNextid="+operatorNextid+"&taskOperatorMsg="+taskOperatorMsg +"&taskOperatorFlag="+taskOperatorFlag
    		+"&operatorNext="+operatorNext+"&flag="+flag+"&processName="+processName+"&processId="+processId;
        	CoreUtil.sendGet(url, null, function (res) {
        		if(res.code!="0"){
        			layer.alert(res.msg);
        			return false;
        		}
        		//JSON.stringify(data.field)
        		layer.msg('流程信息提交成功！' );
        		// 关闭弹出层
        		var iframeIndex = parent.layer.getFrameIndex(window.name);
                parent.layer.close(iframeIndex);
             	layer.close(index);
             	/* var index = layer.alert("流程信息提交成功！", {
		             title: '提交信息'
		         }, function () {
		             
		         }); */
            });
        }
        
        window.refuse = function () {
        	var obj = data_doTask;
        	var operatorNext = $("#operatorNext").val();
        	var operatorNextid = $("#operatorNextid").val();
        	var operatorNext = $("#operatorNext").val();
        	var taskOperatorMsg = $("#taskOperatorMsg").val();
        	var taskOperatorFlag = "驳回";
        	if(taskOperatorMsg.length == 0){
        		layer.alert('审批意见不能为空，请输入审批意见！', {icon: 6});
				 return false;
        	}
            var url = "/flow/task/rejectToCreate?taskId=" + obj.data['id']+"&operatorNextid="+operatorNextid+"&taskOperatorMsg="+taskOperatorMsg
            +"&taskOperatorFlag="+taskOperatorFlag+"&operatorNext="+operatorNext;
        	CoreUtil.sendGet(url, null, function (res) {
        		//JSON.stringify(data.field)
        		layer.msg('流程信息驳回成功！' );
             	/* var index = layer.alert("流程信息驳回成功！", {
		             title: '提交信息'
		         }, function () {}); */
		             // 关闭弹出层
		             var iframeIndex = parent.layer.getFrameIndex(window.name);
		             parent.layer.close(iframeIndex);
		             layer.close(index);
		         
            });
        }
        
        tableSelect.render({
    		elem: '#operatorNext',
    		checkedKey: 'id',
    		table: {
    			url: '/sys/users/listByPageApproverByRole?authorization='+tokenQuery,
    			method: 'POST',
    			where: {processName: processName, taskName: taskName},
    			contentType: 'application/json',
    			// page: false, //开启分页
    			parseData: function (res) { //将原始数据解析成 table 组件所规定的数据
    		        return {
    		          "code": res.code, //解析接口状态
    		          "msg": res.msg, //解析提示文本
    		          "count": CoreUtil.isEmpty(res.data) ? 0 : res.data.total, //解析数据长度
    		          "data": CoreUtil.isEmpty(res.data) ? null : res.data.records //解析数据列表
    		        }
    		      },
    			cols: [ [
    					{ type: 'checkbox' },
    					{ field: 'realName', title: '名称' },
    					{ field: 'username', title: '标题' },
    					{ field: 'id', title: 'ID' ,hide:true}
    				] ]
    		},
    		done: function (elem, data) {
    			var NEWJSONID = [];
    			var NEWJSON = [];
    			layui.each(data.data, function (index, item) {
    				NEWJSON.push(item.realName);
    				NEWJSONID.push(item.username);
    			});
    			console.log('NEWJSON111='+NEWJSON);
    			console.log('NEWJSONID111='+NEWJSONID);
    			elem.val(NEWJSON.join(","));
    			elem.val(NEWJSONID.join(","));
    			$("#operatorNext").val(NEWJSON);
   				$("#operatorNextid").val(NEWJSONID);
    			form.render();
    		}
    	});
        
    });
</script>
</body>
</html>